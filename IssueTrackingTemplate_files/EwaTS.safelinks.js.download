'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[54],{1368:function(w,C,a){a.r(C);var b=a(15),c=a(137),h=a(5);w=a(0);var k=a(14),d=a(79);class f{constructor(H,M,O,L,S,T){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=H;this.WebAffinitizedUrl=M;this.PolicyCookie=O;this.PolicyCookieTTL=L;this.WasServiceDown=S;this.AffinitizedUrl=T}}Object(w.a)(f,
"SafeLinksData",null,[]);class u{constructor(H,M){this.gKc=H;this.stopwatch=M}}Object(w.a)(u,"SafeLinksGetUrlReputationRequestData",null,[]);var r=a(42),t=a(41);class v{constructor(H,M,O,L){this.Oa=H;this.Qi=M;this.RJg=O;v.Hj=L}Bta(H,M,O){try{var L=null;v.Hj&&(L=v.Hj.Ze("WebServiceCall","SafeLinksGetUrlReputation"));const S=new u(M,L);L={};L.AffinitizedUrl=H;L.TargetUrl=M;L.PolicyCookie=O;const T=r.c(L);this.Qi.Ho(this.RJg,2,T,null,!1,2,Object(d.a)(this,this.Y9i,"onGetUrlReputationSuccessCallback"),
Object(d.a)(this,this.X9i,"onGetUrlReputationFailureCallback"),S,void 0,void 0,3E3,3E3,"36");return!0}catch(S){k.ULS.sendTraceTag(588788033,378,10,S.message)}return!1}Y9i(H){let M="OnGetUrlReputationSuccessCallback: ",O=10;const L=H.data.state;try{const S=r.b(H.data.Tf).reputationResults[0],T=S.navigateUrl.length,V=L.gKc.length,la=S.navigateUrl===L.gKc;S.navigateUrl&&0<S.navigateUrl.length&&(L.gKc=S.navigateUrl);M+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",
H.data.httpStatus,S.verdict,V.toString(),T.toString(),la.toString());O=50}catch(S){M+=String.format("Exception {0}",S.message)}this.Skf(L,M,O)}X9i(H){let M="OnGetUrlReputationFailureCallback: ";const O=H.data.state;try{M+=String.format("HttpStatus {0}",H.data.httpStatus)}catch(L){M+=String.format("Exception {0}",L.message)}this.Skf(O,M,10)}Skf(H,M,O){H.stopwatch&&(H.stopwatch.stop(),H.stopwatch=null);k.ULS.sendTraceTag(588788034,378,O,M);t.a.Sg(H.gKc,void 0,"noopener,noreferrer","SafeLinksNav")}}
v.Hj=null;Object(w.a)(v,"SafeLinksNavigationHelper",null,[]);var x;(function(H){H[H.enabledByPolicy=0]="enabledByPolicy";H[H.disabledByPolicy=1]="disabledByPolicy";H[H.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";H[H.disabled_PendingGetPolicyRequest=3]="disabled_PendingGetPolicyRequest"})(x||(x={}));Object(w.b)("SafeLinksNavigationState",x);var m=a(103),l=a(145),n=a(835),z=a(264),y=a(217),B=a(714),G=a(32),E=a(175),J=a(174);class I{constructor(H,M,O,L=!1,S=null,T=null){this.LIa=this.KIa=
0;this.eIb=this.j1b=!1;this.Qva=null;this.s1a=!0;this.M4b=null;k.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.Oa=H;this.Qi=M;this.oua=O;I.Hj=T;this.aTg=L?this.Oa.Sa("SafeLinksHandlerWebServiceBase"):this.Oa.Sa("WebServiceBase");this.KSg=this.Oa.Sa("SafeLinksHashedUserId");this.ipk=this.Oa.Sa("SafeLinksWorkloadIdHeaderValue");this.N2b=this.Oa.Hf("SafeLinksMaxGetPolicyBootRetries",2);this.O2b=this.Oa.Hf("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.P1b=this.isSafeLinksEnabledForUser();
this.O1b=this.EJi();I.Kxe=this.Oa.Sa("UserPrincipalName")||"";I.Kwe=this.Oa.Sa("TenantId")||"";k.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.P1b,this.O1b);if(this.P1b&&this.O1b){M=(H=this.Pza())?H.IsSafeLinksEnabled.toLowerCase():"";O=this.YBd();k.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",M,O);var V=!H||"unknown"===M||H.WasServiceDown||O,la=l.a.Zt();la&&(la.set("shouldGetSafeLinksDataFromServer",
V.toString()),la.set("isSafeLinksEnabledCacheValue",M.toString()));S?(this.s1a=!1,S.execute(Z=>{Z.isFeatureEnabled("MsoUrlreputation",!0).then(da=>{this.s1a=da;la.set("isUserLicensedForSafeLinks",this.s1a.toString());m.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",la);this.s1a&&V&&this.Flc(!0);return null})})):(m.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",la),V&&this.Flc(!0))}}get appName(){return this.oua}get VNc(){return this.aTg}get userId(){return this.KSg}get Yif(){try{if(""===
I.WTc){const H={};H["X-AppName"]=this.appName;H["X-AppVersion"]=h.AFrameworkApplication.buildVersion;H.OS=this.Oa.Sa("PlatformNameAndVersion")||"";const M=JSON.stringify(H);I.WTc=window.self.btoa(M)}}catch(H){k.ULS.sendTraceTag(508909765,378,10,"GetUrlReputationAdditionalProperties Error: {0}",H.message)}return I.WTc}get ydi(){const H=this.VNc?this.VNc+"/":"",M=new z.QueryStringBuilder("SafeLinksHandler.ashx");M.mj("app",this.appName);this.Oa.pa("SafeLinksUseDebugHeader")&&M.mj("action","debug");
this.Oa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&M.mj("s2satpop","1");this.Oa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&M.mj("s2se03","1");return String.format("{0}{1}&{2}",H,M.toString(),h.AFrameworkApplication.Ak)}get Jji(){const H=this.VNc?this.VNc+"/":"",M=new z.QueryStringBuilder("SafeLinksHandler.ashx");M.mj("app",this.appName);this.Oa.pa("SafeLinksUseDebugHeader")&&M.mj("action","debug");this.Oa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",
!1)&&M.mj("s2satpop","1");this.Oa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&M.mj("s2saat","1");this.Oa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&M.mj("s2se03","1");this.Oa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksParamUpdates",!1)&&M.mj("sladpar",this.Yif);M.mj("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",H,M.toString(),h.AFrameworkApplication.Ak)}get E_i(){I.p0c||(I.p0c=new v(this.Oa,
this.Qi,this.Jji,I.Hj));return I.p0c}Bta(H){if(!H)return k.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var M=this.HFi(H);k.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",M,this.P1b,this.O1b,this.s1a);if(!(M&&this.P1b&&this.O1b&&this.s1a))return!1;M=0;const O=({state:M}=this.GZj()).returnValue;k.ULS.sendTraceTag(595079385,378,
50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",x[M]);const L=l.a.Zt();L&&L.set("SafeLinksNavigationState",x[M]);m.Health.instance.recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",L);if(!O)return 2!==M&&3!==M||m.Health.instance.recordKpiFailure("SafeLinksNavigations",x[M],!1,!0,null),!1;k.ULS.sendTraceTag(26019601,378,50,"Using safelinks to navigate hyperlink");if(this.PZj())return this.YBd()?!1:this.E_i.Bta(this.H1h(),H,this.jgf());if(!this.YBd())return this.Nsg(H),!0;this.Qva=
H;k.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.eIb=!1;this.Flc();return!0}HFi(H){H=H.toLowerCase();const M=this.Oa.ay("SafeLinksUnsupportedProtocols");if(M)for(let O=0;O<M.length;O++)if(H.startsWith(M[O]))return!1;return!0}Flc(H=!1){var M=l.a.Zt();M&&M.set("isOnBootRequest",H.toString());m.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",1,"jpittsdirects",M);m.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",0,"jpittsdirects",
M);M=this.Pdd("SafeLinksGetPolicy");this.Qi.Ho(this.ydi,1,null,null,!0,2,Object(d.a)(this,this.$fi,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(d.a)(this,this.Zfi,"getSafeLinksDataFromServer_OnFailureCallback"),M,void 0,void 0,void 0,void 0,"23");this.eIb=H;this.j1b=!0;H?this.KIa++:this.LIa++}$fi(H){let M=y.a.F0i,O="";try{this.j1b=this.eIb=!1;var L=H.data.state;const Y=({stopwatch:L}=this.nJc(L)).returnValue,Ga=Object.assign(new J.a,{durationMs:Y});m.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",
Ga);k.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",H.data.httpStatus,H.data.Tf.length,Y);if(H.data.httpStatus!==y.a.PE)O="Unexpected httpStatus: "+H.data.httpStatus.toString();else{L=null;try{L=r.b(H.data.Tf)}catch(ma){O="Exception:"+ma.toString()+" deserializing response";return}if(L){var S=L.IsSafeLinksEnabled;if(void 0===S||null===S||0>=S.length)O="Invalid isSafeLinksEnabledString";else{k.ULS.sendTraceTag(594830613,
378,50,"Retrieved isSafeLinksEnabledString {0}",S);var T=I.HPd(S);if(void 0===L.WebAffinitizedUrl||null===L.WebAffinitizedUrl||0>=L.WebAffinitizedUrl.length)O="Invalid WebAffinitizedUrl";else if(void 0===L.PolicyCookie||null===L.PolicyCookie||0>=L.PolicyCookie.length)O="Invalid PolicyCookie";else if(void 0===L.PolicyCookieTTL||null===L.PolicyCookieTTL)O="Invalid PolicyCookieTTL";else{var V=L.WebAffinitizedUrl,la=L.PolicyCookie,Z=L.AffinitizedUrl,da=new Date;da.setMinutes(da.getMinutes()+(5<L.PolicyCookieTTL?
L.PolicyCookieTTL-5:0));var ba=da.getTime(),na=new f(S,V,la,ba,!1,Z);this.Deg(na);M=H.data.httpStatus;this.Qva&&(T?(this.Nsg(this.Qva),this.LIa=this.KIa=0):(k.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),m.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,!0,null),t.a.f2(this.Qva)),this.Qva=null)}}}else O="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(Y){O="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+
Y.toString()}finally{M!==y.a.PE&&this.Rkf(M,O)}}Zfi(H){this.j1b=!1;let M=500,O="";try{let L=H.data.state;const S=({stopwatch:L}=this.nJc(L)).returnValue,T=Object.assign(new J.a,{durationMs:S});M=H.data.httpStatus;m.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+M.toString(),!1,!0,T);O="Request Failed, Status="+B.a[H.data.status]+" Duration: "+S}catch(L){O="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+L.toString()}finally{this.Rkf(M,O)}}Rkf(H,M=""){try{if(k.ULS.sendTraceTag(594830612,
378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",H,M),this.KIa<this.N2b&&this.LIa<this.O2b)this.Flc(this.eIb);else{this.eIb=!1;k.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.KIa,this.LIa,H,M);M=null;const O=l.a.Zt();O&&(O.set("HttpStatus",H.toString()),M=Object.assign(new J.a,{extendedProperties:O}));m.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",
!1,!0,M);const L=new f("false","","",0,!0,"");this.Deg(L);this.Qva&&(k.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),m.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),t.a.f2(this.Qva),this.Qva=null)}}catch(O){k.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",O.toString())}}Nsg(H){const M=this.jgf(),O=this.zki(),L={};L.Url=H;L.SafeLinksCookie=
M;L.CorrelationId=E.a.create().toString();L.WorkloadId=this.ipk;L.UserAgentInfo=G.a.Bda+"|"+this.appName;this.Oa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksParamUpdates",!1)&&(L.User=I.Kxe,L.TenantId=I.Kwe,L.AdditionalProperties=this.Yif);k.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",L.CorrelationId);t.a.GAc(t.a.I_(4),O,L)}isSafeLinksEnabledForUser(){const H=this.Oa.Sa("IsSafeLinksEnabledForUser");return H?I.HPd(H):!1}EJi(){const H=this.Oa.ay("SafeLinksDisabledBrowsers");
if(G.a.XD){if(this.Oa.Ur("SafeLinksForTeamsIsEnabled")&&this.Oa.pa("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(H,"Electron"))return!1}else if(Array.contains(H,G.a.Bda))return!1;return"officecomhwa"===(this.Oa.Sa(h.AFrameworkApplication.xba)||"").toLowerCase()?!1:!0}PZj(){return-1!==window.location.href.indexOf("&wd_slnh=1")||this.Oa.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksUseNavigationHelperForMobile",!1)&&G.a.e3?!0:G.a.XD}GZj(){let H;H=0;const M=this.Pza(),O=M?
M.IsSafeLinksEnabled:"";if(""!==O)return M.WasServiceDown?(k.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,state:2}):"false"===O.toLowerCase()?(k.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:I.HPd(O),state:H};if(this.j1b)return H=3,k.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:H};if(this.KIa>=this.N2b||this.LIa>=this.O2b)return H=2,k.ULS.sendTraceTag(51664001,
378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.KIa,this.N2b,this.LIa,this.O2b),{returnValue:!1,state:H};k.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.N2b+this.O2b-(this.KIa+this.LIa));return{returnValue:!0,state:H}}jgf(){const H=this.Pza();return H?H.PolicyCookie:""}zki(){const H=this.Pza();
return H?H.WebAffinitizedUrl:""}H1h(){const H=this.Pza();return H?H.AffinitizedUrl:""}H7h(){const H=new Date;try{const M=this.Pza();H.setTime(M?M.PolicyCookieTTL:0)}catch(M){k.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",M)}return H}YBd(){const H=this.H7h();return!!H&&H.getTime()<Date.now()}Pza(){if(!this.M4b){const H=n.a.instance.getItem(this.userId);if(!H||""===H)return null;this.M4b=JSON.parse(H)}return this.M4b}Deg(H){if(void 0===H||null===
H)throw Error.argumentNull("safeLinksData");if(void 0===H.IsSafeLinksEnabled||null===H.IsSafeLinksEnabled||0>=H.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.M4b=H;H.WasServiceDown||this.rpk(H)}rpk(H){H=JSON.stringify(H);n.a.instance.setItem(this.userId,H)}Pdd(H){return void 0!==I.Hj&&null!==I.Hj?I.Hj.Ze("WebServiceCall",H):null}nJc(H){if(void 0!==H&&null!==H){const M=H.Te;H.stop();return{returnValue:M,stopwatch:null}}return{returnValue:null,stopwatch:H}}static HPd(H){return"false"!==
H.toLowerCase()?!0:!1}}I.Hj=null;I.p0c=null;I.Kwe="";I.Kxe="";I.WTc="";Object(w.a)(I,"SafeLinksManager",null,[489]);const R=H=>{switch(H){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}},X=H=>{switch(H){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};(()=>{Object(c.b)(b.Ac,{yt:"singleton"})(()=>new I(h.AFrameworkApplication.da,h.AFrameworkApplication.tf,String.format("{0}-{1}",R(h.AFrameworkApplication.sa.Ra.kj),
X(h.AFrameworkApplication.sa.Ra.cDa))))})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaTS.safelinks.js.map/a843277bf1092c84c33bd3de30a88f3e/EwaTS.safelinks.js.map